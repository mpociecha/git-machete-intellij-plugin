#!/usr/bin/env bash

# Usage:
# $ ./scripts/run-ui-tests [<intellij-version> [<only-tests>]]

# If <only-tests> is present and non-empty, only the UI test methods
# whose names start with the given prefix will be executed (instead of all UI test methods).

set -e -o pipefail -u

self_dir=$(cd "$(dirname "$0")" &>/dev/null; pwd -P)
source "$self_dir"/utils.sh

intellij_version=${1-}
test_method_prefix=${2-}

if [[ ${CI-} == true ]]; then
  export IDEPROBE_DISPLAY=xvfb
fi

only_tests_flag=${test_method_prefix:+--tests *.$test_method_prefix*}
./gradlew \
  -PenableUiTests \
  -PtestResultsSubdir="$intellij_version" \
  -PintellijVersion="$intellij_version" \
  --info \
  --max-workers=1 \
  -Dorg.gradle.jvmargs=-Xmx256M \
  uiTests:test $only_tests_flag || {
    die 'UI tests failed; inspect Gradle and IDE logs above'
}

if ide_logs_from_this_run | grep -q ' ERROR - '; then
  info 'Logs of IDE under test'
  ide_logs_from_this_run
  die 'UI tests passed, but IDE logs contain errors; inspect Gradle and IDE logs above'
fi
